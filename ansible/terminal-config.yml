---
- name: Terminal config
  hosts: localhost
  become: false
  vars:
    dotfiles_repo: "https://github.com/andreimaxim/dotfiles.git"
    stow_packages:
      - bash
      - git
      - neovim
      - wezterm
      - zellij
      - lazygit
      - tig
  tasks:
    - name: Clone dotfiles repository
      ansible.builtin.git:
        repo: "{{ dotfiles_repo }}"
        dest: "{{ ansible_env.HOME }}/.dotfiles"
        version: main
        update: true

    - name: Stow dotfiles
      ansible.builtin.command:
        argv: "{{ ['stow'] + stow_packages }}"
      args:
        chdir: "{{ ansible_env.HOME }}/.dotfiles"
      changed_when: false

    - name: Ensure .ssh directory exists
      ansible.builtin.file:
        path: "{{ ansible_env.HOME }}/.ssh"
        state: directory
        mode: "0700"

    - name: Configure 1Password SSH agent
      ansible.builtin.blockinfile:
        path: "{{ ansible_env.HOME }}/.ssh/config"
        create: true
        mode: "0600"
        marker: "# {mark} ANSIBLE 1PASSWORD"
        block: |
          Host *
              IdentityAgent ~/.1password/agent.sock
