---
- name: Terminal apps
  hosts: localhost
  become: true
  vars:
    dnf_packages:
      - curl
      - git
      - unzip
      - stow
      - fzf
      - httpd-tools
      - tree
      - tig
      - gh
      - rsync
      - neovim
      - podman
      - podman-tui
    copr_packages:
      - lazygit
    cargo_packages:
      - bat
      - btop
      - eza
      - fd-find
      - ripgrep
      - zoxide
      - zellij
      - starship
    pgdg_major: "18"
    postgresql_client_packages:
      - "postgresql{{ pgdg_major }}"
    mise_tools:
      - ruby@latest
      - node@lts
      - go@latest
      - java@latest
  tasks:
    - name: Refresh dnf cache
      ansible.builtin.dnf:
        update_cache: true

    - name: Enable COPR repositories
      community.general.copr:
        name: "{{ item }}"
        state: enabled
      loop:
        - dejan/lazygit

    - name: Install dnf packages
      ansible.builtin.dnf:
        name: "{{ dnf_packages + copr_packages }}"
        state: present

    - name: Install PGDG repository
      ansible.builtin.dnf:
        name: "https://download.postgresql.org/pub/repos/yum/reporpms/F-{{ ansible_distribution_major_version }}-x86_64/pgdg-fedora-repo-latest.noarch.rpm"
        state: present

    - name: Disable Fedora PostgreSQL module
      ansible.builtin.command: dnf -qy module disable postgresql
      changed_when: false

    - name: Install PostgreSQL client packages
      ansible.builtin.dnf:
        name: "{{ postgresql_client_packages }}"
        state: present

    - name: Ensure local share directory exists
      ansible.builtin.file:
        path: "{{ ansible_env.HOME }}/.local/share"
        state: directory
        mode: "0755"
      become: false

    - name: Download rustup installer
      ansible.builtin.get_url:
        url: https://sh.rustup.rs
        dest: "{{ ansible_env.HOME }}/.local/share/rustup-init.sh"
        mode: "0755"
      become: false

    - name: Install rustup
      ansible.builtin.command:
        argv:
          - "{{ ansible_env.HOME }}/.local/share/rustup-init.sh"
          - -y
          - --default-toolchain
          - stable
      args:
        creates: "{{ ansible_env.HOME }}/.cargo/bin/rustup"
      become: false

    - name: Install cargo packages
      community.general.cargo:
        name: "{{ cargo_packages }}"
        state: present
      environment:
        PATH: "{{ ansible_env.HOME }}/.cargo/bin:{{ ansible_env.PATH }}"
      become: false

    - name: Ensure mise install directory exists
      ansible.builtin.file:
        path: "{{ ansible_env.HOME }}/.local/share/mise"
        state: directory
        mode: "0755"
      become: false

    - name: Download mise installer
      ansible.builtin.get_url:
        url: https://mise.run
        dest: "{{ ansible_env.HOME }}/.local/share/mise/install.sh"
        mode: "0755"
      become: false

    - name: Install mise
      ansible.builtin.command:
        argv:
          - sh
          - "{{ ansible_env.HOME }}/.local/share/mise/install.sh"
      args:
        creates: "{{ ansible_env.HOME }}/.local/bin/mise"
      become: false

    - name: Install mise runtimes
      ansible.builtin.command:
        argv:
          - "{{ ansible_env.HOME }}/.local/bin/mise"
          - use
          - --global
          - "{{ item }}"
      loop: "{{ mise_tools }}"
      environment:
        PATH: "{{ ansible_env.HOME }}/.local/bin:{{ ansible_env.PATH }}"
      changed_when: false
      become: false
